<html lang="en">
<head>
  <meta charset=utf-8/>
  <meta name="referrer" content="no-referrer"/>
  <!--vue依赖-->
  <script src="../../../map/vue-lib/vuejs/vue.js"></script>
  <!--地图依赖js-->
  <script src="../../../map/vue-lib/jslib.3d.js"></script>
  <!--地图依赖js-->
  <script src="../../../map/vue-lib/mapConfig.3d.js"></script>
  <script>
      var viewer=null;
      function loadEnd(){
        console.log("js地图初始化完成,地图对象:",mapVue.$refs.map.viewer);
        viewer=mapVue.$refs.map.viewer;
      }

      var gatherPosition=[];//采集的点信息
      var floatingPoint=null;//移动点
      var drawHandler=null;//画事件
      var layerId="straightArrowLayer";
      function addStraightArrow(){
        console.log("直线箭头");
        gatherPosition=[];
        floatingPoint=null;
        clearPlot();
        drawHandler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        drawHandler.setInputAction(function (event) {
          var position = event.position;
          if (!Cesium.defined(position)) {
            return;
          }
          var ray = viewer.camera.getPickRay(position);
          if (!Cesium.defined(ray)) {
            return;
          }
          var cartesian = viewer.scene.globe.pick(ray, viewer.scene);
          if (!Cesium.defined(cartesian)) {
            return;
          }
          //console.log("点击地图采集的点：",cartesian);
          var num = gatherPosition.length;
          if (num == 0) {
            gatherPosition.push(cartesian);
            floatingPoint = createPoint(cartesian, -1);
            showRegion2Map();
          }
          gatherPosition.push(cartesian);
          var oid = gatherPosition.length - 2;
          createPoint(cartesian, oid);
          if (num > 1) {
            gatherPosition.pop();
            viewer.entities.remove(floatingPoint);
            //console.log("采集点：",gatherPosition);
            //去掉事件
            if(drawHandler){
              drawHandler.destroy();
              drawHandler=null;
            }
            //删除关键点
            clearKeyPoint();
          }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

        drawHandler.setInputAction(function (event) {
          var position = event.endPosition;
          if (!Cesium.defined(position)) {
            return;
          }
          var ray = viewer.camera.getPickRay(position);
          if (!Cesium.defined(ray)) {
            return;
          }
          var cartesian = viewer.scene.globe.pick(ray, viewer.scene);
          if (!Cesium.defined(cartesian)) {
            return;
          }
          if(floatingPoint==null){
            return;
          }
          floatingPoint.position.setValue(cartesian);
          gatherPosition.pop();
          gatherPosition.push(cartesian);
          //console.log("gatherPosition",gatherPosition);
        }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);
      }

      //创建关键点
      function createPoint(cartesian, oid) {
        var point = viewer.entities.add({
          position: cartesian,
          billboard: {
            image: "../images/gatherPoint.png",
            eyeOffset: new Cesium.ConstantProperty(new Cesium.Cartesian3(0, 0, -500)),
            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
          }
        });
        point.oid = oid;
        point.layerId = layerId;
        point.flag = "keypoint";
        return point;
      };

      function showRegion2Map() {
        var material= Cesium.Color.fromCssColorString('#ff0').withAlpha(0.5);
        var outlineMaterial = new Cesium.PolylineDashMaterialProperty({
          dashLength: 16,
          color: Cesium.Color.fromCssColorString('#f00').withAlpha(0.7)
        });

        var dynamicHierarchy = new Cesium.CallbackProperty(function () {
          if (gatherPosition.length > 1) {
            var p1 = gatherPosition[0];
            var p2 = gatherPosition[1];
            if (isSimpleXYZ(p1, p2)) {
              return null;
            }
            var firstPoint = getLonLat(p1);
            var endPoints = getLonLat(p2);
            //console.log("firstPoint：",firstPoint);
            //console.log("endPoints：",endPoints);
            var arrow = xp.algorithm.fineArrow([firstPoint.lon, firstPoint.lat], [endPoints.lon, endPoints.lat]);
            var pHierarchy = new Cesium.PolygonHierarchy(arrow);
            pHierarchy.keyPoints=[firstPoint,endPoints];
            return pHierarchy;
          } else {
            return null;
          }
        }, false);
        var outlineDynamicPositions = new Cesium.CallbackProperty(function () {
          if (gatherPosition.length < 2) {
            return null;
          }
          var p1 = gatherPosition[0];
          var p2 = gatherPosition[1];
          if (isSimpleXYZ(p1, p2)) {
            return null;
          }
          var firstPoint = getLonLat(p1);
          var endPoints = getLonLat(p2);
          //console.log("firstPoint：",firstPoint);
          //console.log("endPoints：",endPoints);
          var arrow = xp.algorithm.fineArrow([firstPoint.lon, firstPoint.lat], [endPoints.lon, endPoints.lat]);
          arrow.push(arrow[0]);
          return arrow;
        }, false);
        var bData = {
          polygon: new Cesium.PolygonGraphics({
            hierarchy: dynamicHierarchy,
            material: material,
            show: true
          }),
          polyline: {
            positions: outlineDynamicPositions,
            clampToGround: true,
            width: 2,
            material: outlineMaterial,
            show: true
          }
        };
        var entity = viewer.entities.add(bData);
        entity.layerId = layerId;
        entity.valueFlag="value";
      }
      /**
       * 判断两点是否一致
       */
      function isSimpleXYZ(p1, p2) {
        if (p1.x == p2.x && p1.y == p2.y && p1.z == p2.z) {
          return true;
        }
        return false;
      }
      /**
       * 笛卡尔坐标转经纬度坐标
       */
      function getLonLat(cartesian) {
        var cartographic =  viewer.scene.globe.ellipsoid.cartesianToCartographic(cartesian);
        cartographic.height = viewer.scene.globe.getHeight(cartographic);
        var pos = {
          lon: cartographic.longitude,
          lat: cartographic.latitude,
          alt: cartographic.height
        };
        pos.lon = Cesium.Math.toDegrees(pos.lon);
        pos.lat = Cesium.Math.toDegrees(pos.lat);
        return pos;
      }


      /**
       * 删除直线箭头
       */
      function clearPlot(){
        var entityList = viewer.entities.values;
        if (entityList == null || entityList.length < 1){
          return;
        }
        for (var i = 0; i < entityList.length; i++) {
          var entity = entityList[i];
          if (entity.layerId == layerId) {
            viewer.entities.remove(entity);
            i--;
          }
        }
      }

      /**
       * 删除关键点
       */
      function clearKeyPoint(){
        var entityList = viewer.entities.values;
        if (entityList == null || entityList.length < 1){
          return;
        }
        for (var i = 0; i < entityList.length; i++) {
          var entity = entityList[i];
          if(entity.flag=="keypoint"){
            viewer.entities.remove(entity);
            i--;
          }
        }
      }
      /**
       * 获取采集的直线箭头数据
       */
      function getStraightArrowValue(){
        //删除关键点
        clearKeyPoint();
        var entityList = viewer.entities.values;
        for (var i = 0; i < entityList.length; i++) {
          var entity = entityList[i];
          if(typeof (entity.valueFlag)!="undefined"){
            console.log("采集的直线箭头(笛卡尔)：",entity.polygon.hierarchy.getValue().positions);
            var dke=entity.polygon.hierarchy.getValue().positions;
            var objArr=[];
            for(var i=0;i<dke.length;i++){
              var ellipsoid=viewer.scene.globe.ellipsoid;
              var cartesian3=new Cesium.Cartesian3(dke[i].x,dke[i].y,dke[i].z);
              var cartographic=ellipsoid.cartesianToCartographic(cartesian3);
              //console.log("cartographic",cartographic);
              var obj={};
              obj.lat=Cesium.Math.toDegrees(cartographic.latitude);
              obj.lng=Cesium.Math.toDegrees(cartographic.longitude);
              //obj.alt=0;
              objArr.push(obj);
            }
            console.log("采集的直线箭头(经纬度)",objArr);
            console.log("采集的直线箭头关键点",entity.polygon.hierarchy.getValue().keyPoints);
          }

        }
      }

  </script>
</head>

<body>
<div id="my-app">
  <el-button type="primary" onclick='addStraightArrow();' style='z-index:1000;position:absolute;top:50px;left:60px'>直线箭头
  </el-button>
  <el-button type="primary" onclick='getStraightArrowValue();' style='z-index:1000;position:absolute;top:100px;left:50px'>获取采集数据
  </el-button>
  <map-component ref="map" :id="id" :type="type" :config="config" :load-end="loadEndFun"  style='z-index:100;position: absolute;top: 0; bottom: 0;right: 0;left: 0;'></map-component>
</div>
<script>
    var mapVue = new Vue({
        el: '#my-app',
        data: {
            //地图配置信息（必须）
            id: "map",
            type: "js",
            config: window.defaultMapConfig,
            //地图加载完成回调方法
            loadEndFun:"loadEnd"
        },
        components: {
            'map-component': httpVueLoader('../../vue-map3d-component/cesium/map3d-component.vue', 'frontEnd')
        },
        mounted(){

        }
    });
</script>
</body>
</html>
