<html lang="en">
<head>
  <meta charset=utf-8/>
  <meta name="referrer" content="no-referrer"/>
  <!--vue依赖-->
  <script src="../../../map/vue-lib/vuejs/vue.js"></script>
  <!--地图依赖js-->
  <script src="../../../map/vue-lib/jslib.3d.js"></script>
  <!--地图依赖js-->
  <script src="../../../map/vue-lib/mapConfig.3d.js"></script>
  <script>



    var viewer = null;
    function loadEnd() {
      /* 解决加载gltf2.0报错的问题 */
      var fixGltf = function (gltf) {
        if (!gltf.extensionsUsed || !gltf.extensionsRequired) {
          return;
        }
        var v = gltf.extensionsUsed.indexOf('KHR_technique_webgl');
        var t = gltf.extensionsRequired.indexOf('KHR_technique_webgl');
        if (v !== -1) {
          gltf.extensionsRequired.splice(t, 1, 'KHR_techniques_webgl');
          gltf.extensionsUsed.splice(v, 1, 'KHR_techniques_webgl');
          gltf.extensions = gltf.extensions || {};
          gltf.extensions['KHR_techniques_webgl'] = {};
          gltf.extensions['KHR_techniques_webgl'].programs = gltf.programs;
          gltf.extensions['KHR_techniques_webgl'].shaders = gltf.shaders;
          gltf.extensions['KHR_techniques_webgl'].techniques = gltf.techniques;
          var techniques = gltf.extensions['KHR_techniques_webgl'].techniques;

          gltf.materials.forEach(function (mat, index) {
            gltf.materials[index].extensions['KHR_technique_webgl'].values = gltf.materials[index].values;
            gltf.materials[index].extensions['KHR_techniques_webgl'] = gltf.materials[index].extensions['KHR_technique_webgl'];

            var vtxfMaterialExtension = gltf.materials[index].extensions['KHR_techniques_webgl'];

            for (var value in vtxfMaterialExtension.values) {
              var us = techniques[vtxfMaterialExtension.technique].uniforms;
              for (var key in us) {
                if (us[key] === value) {
                  vtxfMaterialExtension.values[key] = vtxfMaterialExtension.values[value];
                  delete vtxfMaterialExtension.values[value];
                  break;
                }
              }
            };
          });

          techniques.forEach(function (t) {
            for (var attribute in t.attributes) {
              var name = t.attributes[attribute];
              t.attributes[attribute] = t.parameters[name];
            };

            for (var uniform in t.uniforms) {
              var name = t.uniforms[uniform];
              t.uniforms[uniform] = t.parameters[name];
            };
          });
        }
      }

      Object.defineProperties(Cesium.Model.prototype, {
        _cachedGltf: {
          set: function (value) {
            this._vtxf_cachedGltf = value;
            if (this._vtxf_cachedGltf && this._vtxf_cachedGltf._gltf) {
              fixGltf(this._vtxf_cachedGltf._gltf);
            }
          },
          get: function () {
            return this._vtxf_cachedGltf;
          }
        }
      });



      viewer = mapVue.$refs.map.viewer;
      console.log("js地图初始化完成,地图对象:", mapVue.$refs.map.viewer);

      //优化项--关闭相关特效
      viewer.scene.debugShowFramesPerSecond = true;//显示fps
      viewer.scene.moon.show = false;//月亮
      viewer.scene.fog.enabled = false;//雾
      viewer.scene.sun.show = false;//太阳
      viewer.scene.skyBox.show = false;//天空盒
      viewer.resolutionScale =1.0;//画面细度，默认值为1.0

      var tileset = viewer.scene.primitives.add(new Cesium.Cesium3DTileset({
        url: '../../../data/dayanta/tileset.json',
        maximumMemoryUsage: 100,//不可设置太高，目标机子空闲内存值以内，防止浏览器过于卡
        maximumScreenSpaceError: 20,//用于驱动细节细化级别的最大屏幕空间错误;较高的值可提供更好的性能，但视觉质量较低。
        maximumNumberOfLoadedTiles: 1000,  //最大加载瓦片个数
        shadows: false,//是否显示阴影
        skipLevelOfDetail: true,
        baseScreenSpaceError: 1024,
        skipScreenSpaceErrorFactor: 16,
        skipLevels: 1,
        immediatelyLoadDesiredLevelOfDetail: false,
        loadSiblings: false,
        cullWithChildrenBounds: true,
        dynamicScreenSpaceError: true,
        dynamicScreenSpaceErrorDensity: 0.00278,
        dynamicScreenSpaceErrorFactor: 4.0,
        dynamicScreenSpaceErrorHeightFalloff: 0.25
      }));
      viewer.scene.primitives.add(tileset);
      mapVue.$refs.map.viewer.flyTo(tileset);

    }


  </script>
</head>

<body>
<div id="my-app">
  <map-component ref="map" :id="id" :type="type" :config="config" :load-end="loadEndFun"
                 style='z-index:100;position: absolute;top: 0; bottom: 0;right: 0;left: 0;'></map-component>
</div>
<script>
  var mapVue = new Vue({
    el: '#my-app',
    data: {
      //地图配置信息（必须）
      id: "map",
      type: "js",
      config: window.defaultMapConfig,
      //地图加载完成回调方法
      loadEndFun: "loadEnd"
    },
    components: {
      'map-component': httpVueLoader('../../vue-map3d-component/cesium/map3d-component.vue', 'frontEnd')
    },
    mounted() {

    }
  });
</script>
</body>
</html>
